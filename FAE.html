<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sveaverken FAE Availability</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --ok:#c8f7c5;
      --bad:#ffd4d4;
      --chip-ok:#2e7d32;
      --chip-bad:#c62828;
      --ink:#111;
      --muted:#666;
      --line:#333;
      --card:#f7f9fc;
      --radius:12px;
      --shadow:0 2px 10px rgba(0,0,0,.12);
      --accent:#005bbb;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:'Roboto Mono', monospace; color:var(--ink); background:#fff;
    }
    header{
      text-align:center; padding:16px 12px 8px;
    }
    #logo{ width:min(520px,90%); height:auto; vertical-align:middle }
    h2{margin:10px 0 0}

    .toolbar{
      max-width:1200px; margin:12px auto 0; display:flex; gap:12px;
      align-items:center; justify-content:center; flex-wrap:wrap; padding:0 12px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; box-shadow:var(--shadow);
      background:#fff;
    }
    .chip small{color:var(--muted)}
    .dot{width:10px; height:10px; border-radius:50%}

    #holidayBanner{
      max-width:1200px; margin:16px auto; padding:14px 16px; border:2px dashed #444; background:#fffacd; border-radius:12px;
    }
    #holidayBanner h3{margin:6px 0 10px; text-align:center}
    #holidayList{display:flex; gap:10px; flex-wrap:wrap; list-style:none; padding:0; margin:0; justify-content:center}
    #holidayList li{background:#fff; padding:6px 10px; border-radius:999px; box-shadow:var(--shadow); border:1px solid #eee}

    .table-wrap{
      width:100%; overflow:auto; padding:0 12px;
    }
    table{
      border-collapse:collapse; width:95%; min-width:860px; margin:16px auto;
      border:2px solid var(--line); box-shadow:var(--shadow); background:#fff; border-radius:12px; overflow:hidden;
    }
    th,td{ border:1px solid var(--line); padding:10px; text-align:center; white-space:nowrap }
    thead th{ background:#f0f0f0; position:sticky; top:0; z-index:1 }
    tbody tr:nth-child(even){ background:#fafafa }

    .available{ background:var(--ok) }
    .unavailable{ background:var(--bad) }

    .status-badge{
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-weight:700; color:#fff
    }
    .status-ok{ background:var(--chip-ok) }
    .status-bad{ background:var(--chip-bad) }

    .controls{
      display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; margin:8px auto 0;
    }
    input[type="search"], select{
      padding:8px 10px; border:1px solid #ccc; border-radius:10px; font-family:inherit
    }

    #upcomingWeekend{
      text-align:center; padding:18px; border:3px solid #333; border-radius:10px; background: #e8f2ff;
      box-shadow:var(--shadow); margin:24px auto; width:min(900px,92%); font-weight:700
    }
    #upcomingWeekend h3{margin:0 0 10px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header id="header">
    <img id="logo" src="https://www-sveaverken-com.azureedge.net/web/image/website/5/logo/Sveaverken%20-%20Official%20Website?unique=54b527b" alt="Sveaverken Logo" />
    <h2>Sveaverken FAE Availability</h2>
  </header>

  <div class="toolbar" aria-live="polite">
    <span class="chip" id="nowGMT8">
      <span class="dot" style="background:#222"></span>
      GMT+8 now: <strong id="clockG8">--:--:--</strong>
      <small>(visibility logic uses GMT+8)</small>
    </span>
    <span class="chip">
      Your time: <strong id="clockLocal">--:--:--</strong>
    </span>
    <span class="chip">
      Available now: <strong id="availableCount">0</strong>
    </span>
  </div>

  <div class="controls">
    <input id="searchBox" type="search" placeholder="Filter by name, language…" />
    <select id="countryFilter">
      <option value="">All countries</option>
    </select>
    <select id="statusFilter">
      <option value="">All statuses</option>
      <option value="available">Available</option>
      <option value="unavailable">Unavailable</option>
    </select>
    <button id="sortBtn" type="button">Sort: Available → Unavailable</button>
  </div>

  <div id="holidayBanner" aria-live="polite">
    <h3>Countries with a public holiday today (with active FAE):</h3>
    <ul id="holidayList"></ul>
  </div>

  <div class="table-wrap">
    <table id="faeTable" aria-describedby="header">
      <thead>
        <tr>
          <th>Name</th>
          <th>Work Hours (GMT+8)</th>
          <th>Work Hours (Local Time)</th>
          <th>Country</th>
          <th>Actual Local Time</th>
          <th>Languages Spoken</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="faeBody"></tbody>
    </table>
  </div>

  <div id="upcomingWeekend">
    <h3>Upcoming Weekend Schedule</h3>
    <div id="saturdaySchedule">Saturday: loading…</div>
    <div id="sundaySchedule">Sunday: loading…</div>
    <div class="muted" id="weekendNote"></div>
  </div>

  <script>
    const faeData = [
      { "Engineer": "Jeffery Zhu",        "GMT+8": "12:00-24:00", "Local Time": "12:00-24:00", "Country": "CN", "Languages": "English, Chinese",   "TimeZone": "Asia/Shanghai" },
      { "Engineer": "Dincer Meydanli",    "GMT+8": "13:30-02:30", "Local Time": "08:30-21:30", "Country": "TR", "Languages": "English, Turkish",   "TimeZone": "Europe/Istanbul" },
      { "Engineer": "Mehmet Cebe",        "GMT+8": "13:30-02:30", "Local Time": "08:30-21:30", "Country": "TR", "Languages": "English, Turkish",   "TimeZone": "Europe/Istanbul" },
      { "Engineer": "Dogukan Karabuga",   "GMT+8": "13:30-02:30", "Local Time": "08:30-21:30", "Country": "TR", "Languages": "English, Turkish",   "TimeZone": "Europe/Istanbul" },
      { "Engineer": "Guven Ulas",         "GMT+8": "13:30-02:30", "Local Time": "08:30-21:30", "Country": "TR", "Languages": "English, Turkish",   "TimeZone": "Europe/Istanbul" },
      { "Engineer": "Roque Martinez",     "GMT+8": "22:30-10:00", "Local Time": "08:30-20:00", "Country": "MX", "Languages": "English, Spanish",   "TimeZone": "America/Mexico_City" },
      { "Engineer": "Xengges Sai",        "GMT+8": "12:00-24:00", "Local Time": "10:00-24:00", "Country": "CN", "Languages": "English, Chinese",   "TimeZone": "Asia/Shanghai" },
      { "Engineer": "Xin Yang",           "GMT+8": "10:00-24:00", "Local Time": "10:00-24:00", "Country": "CN", "Languages": "English, Chinese",   "TimeZone": "Asia/Shanghai" },
      { "Engineer": "Jesus Casassixto",   "GMT+8": "22:30-10:00", "Local Time": "09:30-21:00", "Country": "MX", "Languages": "English, Spanish",   "TimeZone": "America/Mexico_City" },
      { "Engineer": "Alexa Bautista",     "GMT+8": "15:00-02:00", "Local Time": "15:00-02:00", "Country": "PH", "Languages": "English",            "TimeZone": "Asia/Manila" },
      { "Engineer": "Jeffersson Nolasco", "GMT+8": "15:00-02:00", "Local Time": "15:00-02:00", "Country": "PH", "Languages": "English",            "TimeZone": "Asia/Manila" },
      { "Engineer": "Ilgner Boer",        "GMT+8": "22:30-10:00", "Local Time": "11:30-23:00", "Country": "BR", "Languages": "English, Portuguese","TimeZone": "America/Sao_Paulo" },
      { "Engineer": "Mariusz Niezgoda",   "GMT+8": "14:30-02:30", "Local Time": "07:30-20:30", "Country": "PL", "Languages": "English, Polish",    "TimeZone": "Europe/Warsaw" },
      { "Engineer": "Kamil Jabłoński",    "GMT+8": "14:30-02:30", "Local Time": "07:30-20:30", "Country": "PL", "Languages": "English, Polish",    "TimeZone": "Europe/Warsaw" }
    ];

    // Keep as many future entries as you want here
    const weekendSchedule = [
      { date: '2025-06-21', day: 'Saturday', fae: 'Kamil-PL (GMT+1) — Jeff' },
      { date: '2025-06-22', day: 'Sunday',   fae: 'Mehmet Sehmus (GMT+3) — Jeff' }
    ];

    // ------- Utils -------
    function toDecimal(hhmm){
      const [h,m] = hhmm.split(':').map(Number);
      return (h % 24) + (m || 0)/60;
    }
    function parseRange(r){
      const [a,b] = r.split('-');
      return [toDecimal(a), toDecimal(b)];
    }
    function nowInGMT8Decimal(){
      const now = new Date();
      const h = (now.getUTCHours() + 8 + 24) % 24;
      return h + now.getUTCMinutes()/60 + now.getUTCSeconds()/3600;
    }
    function isInRangeGMT8(rangeStr){
      const [start,end] = parseRange(rangeStr);
      const t = nowInGMT8Decimal();
      if (start === end) return true; // 24/7
      return start > end ? (t >= start || t < end) : (t >= start && t < end);
    }
    function pad(n){ return String(n).padStart(2,'0'); }

    // ------- Clocks -------
    function tickClocks(){
      const now = new Date();
      const g8 = new Date(now.getTime() + (8 - now.getTimezoneOffset()/60)*3600*1000 - now.getHours()*3600*1000 + now.getHours()*3600*1000); // display via formatter instead
      document.getElementById('clockLocal').textContent =
        new Intl.DateTimeFormat('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).format(now);

      const gmt8Text = new Intl.DateTimeFormat('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:'Asia/Shanghai'}).format(now);
      document.getElementById('clockG8').textContent = gmt8Text;
    }
    setInterval(tickClocks, 1000);
    tickClocks();

    // ------- Table rendering -------
    const tbody = document.getElementById('faeBody');
    let currentRows = [];

    function rowFor(fae){
      const tr = document.createElement('tr');
      const available = isInRangeGMT8(fae["GMT+8"]);
      tr.className = available ? 'available' : 'unavailable';

      tr.insertCell().textContent = fae.Engineer;
      tr.insertCell().textContent = fae["GMT+8"];
      tr.insertCell().textContent = fae["Local Time"];
      tr.insertCell().textContent = fae.Country;

      const localTimeCell = tr.insertCell();
      startLocalClock(localTimeCell, fae.TimeZone);

      tr.insertCell().textContent = fae.Languages;

      const status = tr.insertCell();
      const badge = document.createElement('span');
      badge.className = 'status-badge ' + (available ? 'status-ok' : 'status-bad');
      badge.innerHTML = (available ? 'Available' : 'Unavailable');
      status.appendChild(badge);

      tr.dataset.country = fae.Country;
      tr.dataset.status = available ? 'available' : 'unavailable';
      tr.dataset.search = [fae.Engineer, fae.Languages, fae.Country].join(' ').toLowerCase();

      return tr;
    }

    function startLocalClock(cell, timeZone){
      function update(){
        const t = new Intl.DateTimeFormat('en-GB',{
          hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false, timeZone
        }).format(new Date());
        cell.textContent = t;
      }
      update();
      setInterval(update, 1000);
    }

    function renderTable(list){
      tbody.innerHTML = '';
      list.forEach(f => tbody.appendChild(rowFor(f)));
      updateSummary();
    }

    function updateStatuses(){
      const rows = [...tbody.rows];
      rows.forEach(r=>{
        const g = r.cells[1].textContent;
        const ok = isInRangeGMT8(g);
        r.className = ok ? 'available' : 'unavailable';
        r.dataset.status = ok ? 'available' : 'unavailable';
        const badge = r.cells[6].querySelector('.status-badge');
        badge.className = 'status-badge ' + (ok ? 'status-ok' : 'status-bad');
        badge.textContent = ok ? 'Available' : 'Unavailable';
      });
      updateSummary();
    }
    setInterval(updateStatuses, 30_000);

    function updateSummary(){
      const rows = [...tbody.rows];
      const available = rows.filter(r => r.dataset.status === 'available').length;
      document.getElementById('availableCount').textContent = available;
    }

    // ------- Filters & Sort -------
    const searchBox = document.getElementById('searchBox');
    const countryFilter = document.getElementById('countryFilter');
    const statusFilter = document.getElementById('statusFilter');
    const sortBtn = document.getElementById('sortBtn');
    let sortAvailableFirst = true;

    function applyFilters(){
      const q = searchBox.value.trim().toLowerCase();
      const ctry = countryFilter.value;
      const stat = statusFilter.value;

      const rows = [...tbody.rows];
      rows.forEach(r=>{
        const matchQ = !q || r.dataset.search.includes(q);
        const matchC = !ctry || r.dataset.country === ctry;
        const matchS = !stat || r.dataset.status === stat;
        r.style.display = (matchQ && matchC && matchS) ? '' : 'none';
      });
    }

    function applySort(){
      const rows = [...tbody.rows];
      rows.sort((a,b)=>{
        const av = a.dataset.status === 'available' ? 0 : 1;
        const bv = b.dataset.status === 'available' ? 0 : 1;
        const dir = sortAvailableFirst ? 1 : -1;
        if (av !== bv) return (av - bv) * dir;
        return a.cells[0].textContent.localeCompare(b.cells[0].textContent);
      });
      rows.forEach(r=>tbody.appendChild(r));
    }

    searchBox.addEventListener('input', applyFilters);
    countryFilter.addEventListener('change', applyFilters);
    statusFilter.addEventListener('change', applyFilters);
    sortBtn.addEventListener('click', ()=>{
      sortAvailableFirst = !sortAvailableFirst;
      sortBtn.textContent = `Sort: ${sortAvailableFirst ? 'Available → Unavailable' : 'Unavailable → Available'}`;
      applySort();
    });

    function populateCountryFilter(){
      const codes = Array.from(new Set(faeData.map(f=>f.Country))).sort();
      codes.forEach(c=>{
        const opt = document.createElement('option');
        opt.value = opt.textContent = c;
        countryFilter.appendChild(opt);
      });
    }

    // ------- Weekend schedule -------
    function nextWeekendDates(){
      const now = new Date();
      const day = now.getDay(); // 0=Sun..6=Sat
      const sat = new Date(now);
      sat.setHours(0,0,0,0);
      sat.setDate(now.getDate() + ((6 - day + 7) % 7));
      const sun = new Date(sat);
      sun.setDate(sat.getDate() + 1);
      return { sat, sun };
    }

    function fmtISO(d){ return d.toISOString().slice(0,10); }

    function displayUpcomingWeekend(){
      const { sat, sun } = nextWeekendDates();
      const satStr = fmtISO(sat), sunStr = fmtISO(sun);

      const satEntry = weekendSchedule.find(d=>d.date === satStr);
      const sunEntry = weekendSchedule.find(d=>d.date === sunStr);

      const fallbackNext = weekendSchedule
        .map(d=>({ ...d, when: new Date(d.date+'T00:00:00Z') }))
        .filter(d=> d.when >= new Date(new Date().toISOString().slice(0,10)+'T00:00:00Z'))
        .sort((a,b)=> a.when - b.when);

      document.getElementById('saturdaySchedule').textContent =
        satEntry ? `Saturday (${satStr}): ${satEntry.fae}` :
        `Saturday (${satStr}): No schedule available`;

      document.getElementById('sundaySchedule').textContent =
        sunEntry ? `Sunday (${sunStr}): ${sunEntry.fae}` :
        `Sunday (${sunStr}): No schedule available`;

      const note = document.getElementById('weekendNote');
      if(!satEntry || !sunEntry){
        if (fallbackNext.length){
          note.textContent = `Next planned entry: ${fallbackNext[0].day} ${fallbackNext[0].date} — ${fallbackNext[0].fae}`;
        } else {
          note.textContent = '';
        }
      } else {
        note.textContent = '';
      }
    }

    // ------- Holidays (Nager API) -------
    async function displayPublicHolidays(){
      const ul = document.getElementById('holidayList');
      ul.innerHTML = '<li>Checking…</li>';

      const countries = [...new Set(faeData.map(f=>f.Country))];
      const todayISO = new Date().toISOString().slice(0,10);
      const year = new Date().getFullYear();

      const activeNow = new Set(
        faeData.filter(f=>isInRangeGMT8(f["GMT+8"])).map(f=>f.Country)
      );

      const found = [];
      for (const code of countries){
        try{
          const res = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/${code}`);
          if(!res.ok) continue;
          const days = await res.json();
          const today = days.find(h=>h.date === todayISO);
          if (today && activeNow.has(code)){
            found.push(`${today.localName} (${code})`);
          }
        }catch(e){ /* ignore */ }
      }

      ul.innerHTML = '';
      if(found.length){
        found.forEach(txt=>{
          const li = document.createElement('li');
          li.textContent = txt;
          ul.appendChild(li);
        });
      } else {
        ul.innerHTML = '<li>No public holidays today in FAE countries with active engineers.</li>';
      }
    }

    // ------- Init -------
    function init(){
      populateCountryFilter();
      renderTable(faeData);
      applySort();
      applyFilters();
      displayUpcomingWeekend();
      displayPublicHolidays();
    }
    window.addEventListener('load', init);
  </script>
</body>
</html>
